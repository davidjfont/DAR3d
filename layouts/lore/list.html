{{ define "main" }}

<style>
  :root {
    --wiki-accent: var(--tw-colors-fox-red);
    --wiki-border: rgba(229, 68, 42, 0.3);
    /* Dynamic glass background based on theme */
    --wiki-bg-glass: color-mix(in srgb, var(--color-ui-dark-gray) 80%, transparent);
  }

  [data-theme="light"] .wiki-section {
    background: rgba(10, 10, 10, 0.1);
  }

  .wikibody {
    max-width: 1000px;
    margin: 4rem auto;
    padding: 3rem 2rem;
    background: var(--wiki-bg-glass);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(245, 243, 238, 0.05);
    border-radius: 32px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
    color: var(--tw-colors-bone-white);
  }

  .wikibody h1 {
    font-family: var(--tw-font-family-title);
    font-size: 2.5rem;
    color: var(--tw-colors-neon-green);
    text-shadow: 0 0 15px rgba(92, 255, 191, 0.2);
    margin-bottom: 2rem;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .wikibody h2,
  .wikibody h3 {
    font-family: var(--tw-font-family-title);
    color: var(--tw-colors-bone-white);
    margin-top: 2rem;
    margin-bottom: 1rem;
    text-transform: uppercase;
    border-bottom: 1px solid var(--wiki-border);
    padding-bottom: 0.5rem;
    display: inline-block;
  }

  .wikibody p {
    line-height: 1.7;
    margin-bottom: 1.5rem;
    color: var(--color-prose-text);
  }

  /* WIKI LIST LINKS */
  .wikibody ul {
    list-style: none;
    padding-left: 0;
    display: grid;
    gap: 0.75rem;

  }

  .wikibody li {
    position: relative;
  }

  .wikibody a[href^='/lore/'],
  .wikibody a[href^='/en/lore/'] {
    display: flex;
    align-items: center;
    padding: 1rem 1.5rem;
    background: rgba(32, 35, 38, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    color: var(--tw-colors-bone-white);
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .wikibody a[href^='/lore/']:hover,
  .wikibody a[href^='/en/lore/']:hover {
    background: rgba(229, 68, 42, 0.1);
    border-color: var(--tw-colors-fox-red);
    transform: translateX(8px);
    box-shadow: -5px 0 15px rgba(229, 68, 42, 0.2);
  }

  /* INDICATOR ICON */
  .wikibody a[href^='/lore/']::after,
  .wikibody a[href^='/en/lore/']::after {
    content: "›";
    position: absolute;
    right: 1.5rem;
    font-size: 1.5rem;
    transition: transform 0.4s ease;
    color: var(--tw-colors-neon-green);
  }

  .wikibody a.active {
    background: rgba(229, 68, 42, 0.15) !important;
    border-color: var(--tw-colors-fox-red) !important;
    color: var(--tw-colors-neon-green);
  }

  .wikibody a.active::after {
    transform: rotate(90deg);
  }

  /* WIKI SECTION CONTENT */
  .wiki-section {
    margin: 1rem 0 2rem 2rem;
    padding: 2rem;
    background: rgba(10, 10, 10, 0.1);
    border: 1px solid var(--wiki-border);
    border-left: 4px solid var(--tw-colors-neon-green);
    border-radius: 0 16px 16px 16px;
    display: none;
    animation: wikiExpand 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
  }

  @keyframes wikiExpand {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* SCANNING LOADER */
  .wiki-loading {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-family: monospace;
    color: var(--tw-colors-neon-green);
    font-size: 0.9rem;
    letter-spacing: 2px;
  }

  .scanning-beam {
    width: 20px;
    height: 2px;
    background: var(--tw-colors-neon-green);
    animation: scanning 1s infinite alternate;
    box-shadow: 0 0 10px var(--tw-colors-neon-green);
  }

  @keyframes scanning {
    from {
      width: 5px;
      opacity: 0.5;
    }

    to {
      width: 40px;
      opacity: 1;
    }
  }

  /* PROSE INSIDE WIKI */
  .wiki-section article {
    font-size: 1.05rem;
    line-height: 1.8;
  }

  .wiki-section ul {
    list-style: disc !important;
    padding-left: 2rem !important;
    margin-bottom: 1.5rem !important;
    display: block !important;
    /* Ensure it's not grid like the parent */
  }

  .wiki-section li {
    color: var(--color-prose-text) !important;
    margin-bottom: 0.75rem !important;
    list-style-type: disc !important;
  }

  .wiki-section p {
    color: var(--color-prose-text) !important;
  }

  .wiki-section h1 {
    font-size: 1.8rem;
    margin-top: 0;
  }

  .wiki-section img {
    border-radius: 12px;
    margin: 1.5rem 0;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
</style>

<article class="wikibody">
  {{ .Content }}

  <div id="wiki-container"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.body.addEventListener("click", async function (e) {
        const link = e.target.closest("a[href^='/lore/'], a[href^='/en/lore/']");
        if (!link) return;

        // Skip non-expandable links (like homepage link at bottom)
        if (link.closest("nav") || link.closest("#mobile-menu") || link.closest("header")) return;

        // Exclude the final Dar3D logo link if it points to root
        if (link.getAttribute("href") === "/" || link.getAttribute("href") === "/en/") return;

        e.preventDefault();

        const url = link.href;
        const id = "section-" + btoa(url).replace(/=/g, "");
        const li = link.closest("li") || link.parentElement;

        let existing = document.getElementById(id);

        // Toggle if exists
        if (existing) {
          if (existing.style.display === "none") {
            existing.style.display = "block";
            link.classList.add("active");
          } else {
            existing.style.display = "none";
            link.classList.remove("active");
          }
          return;
        }

        // Deactivate others maybe? User said "don't break", usually better to allow multi-expand in wiki

        // Create Section
        const section = document.createElement("div");
        section.id = id;
        section.className = "wiki-section";
        section.innerHTML = `
          <div class="wiki-loading">
            <div class="scanning-beam"></div>
            <span>ANALIZANDO_NODO_...</span>
          </div>
        `;

        li.insertAdjacentElement("afterend", section);
        link.classList.add("active");
        section.style.display = "block";

        try {
          const response = await fetch(url);
          const text = await response.text();

          const parser = new DOMParser();
          const doc = parser.parseFromString(text, "text/html");
          const article = doc.querySelector("article");

          if (article) {
            // Clean up content: remove the fetched h1 title if it's the same as the link
            const content = article.innerHTML;
            section.innerHTML = `<div>${content}</div>`;
          } else {
            section.innerHTML = "<p>DATOS_CORRUPTOS_O_INVALIDOS</p>";
          }

        } catch (err) {
          console.error(err);
          section.innerHTML = "<p>ERROR_DE_SINCRONIZACIÓN</p>";
        }
      });
    });
  </script>
</article>

{{ end }}