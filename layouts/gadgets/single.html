{{ define "main" }}

<style>
  .gadget-single {
    max-width: 1100px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
    color: var(--tw-colors-bone-white);
  }

  .gadget-title {
    font-family: var(--tw-font-family-title);
    font-size: 3rem;
    color: var(--tw-colors-neon-green);
    margin-top: 1rem;
    margin-bottom: 2rem;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  /* PREVIEW & VISOR */
  .visual-container {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(229, 68, 42, 0.3);
    border-radius: 20px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
  }

  #preview {
    width: 100%;
    display: block;
    cursor: pointer;
    transition: transform 0.5s ease;
  }

  #preview:hover {
    transform: scale(1.02);
  }

  #visor {
    width: 100%;
    height: 600px;
    background: transparent;
  }

  /* BUTTONS TECH */
  .btn-tech-back {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: transparent;
    border: 1px solid rgba(92, 255, 191, 0.4);
    color: var(--tw-colors-neon-green);
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    font-family: monospace;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    margin-bottom: 1.5rem;
  }

  .btn-tech-back:hover {
    background: rgba(92, 255, 191, 0.1);
    box-shadow: 0 0 15px rgba(92, 255, 191, 0.3);
  }

  .btn-solicitar-fixed {
    position: absolute;
    bottom: 2rem;
    left: 2rem;
    background: var(--tw-colors-fox-red);
    color: white;
    padding: 0.8rem 1.5rem;
    border-radius: 12px;
    text-decoration: none;
    font-weight: bold;
    font-family: var(--tw-font-family-title);
    font-size: 0.9rem;
    z-index: 1000;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(229, 68, 42, 0.4);
  }

  .btn-solicitar-fixed:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(229, 68, 42, 0.6);
    filter: brightness(1.1);
  }

  /* CONTROL PANEL */
  #panel {
    margin-top: 2rem;
    padding: 1.5rem;
    background: rgba(32, 35, 38, 0.8);
    border: 1px solid rgba(229, 68, 42, 0.2);
    border-radius: 16px;
    backdrop-filter: blur(10px);
    max-width: 600px;
  }

  #panel h3 {
    margin-top: 0;
    color: var(--tw-colors-fox-red);
    font-family: var(--tw-font-family-title);
    font-size: 1.1rem;
    text-transform: uppercase;
    margin-bottom: 1.5rem;
  }

  .panel-label {
    display: block;
    font-size: 0.8rem;
    color: rgba(245, 243, 238, 0.6);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .panel-row {
    margin-bottom: 1.5rem;
  }

  /* FORM ELEMENTS */
  .tech-select,
  .tech-btn {
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(245, 243, 238, 0.2);
    color: var(--tw-colors-bone-white);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-family: inherit;
    width: 100%;
    cursor: pointer;
  }

  .tech-btn {
    text-transform: uppercase;
    font-weight: bold;
    letter-spacing: 1px;
    font-size: 0.8rem;
    transition: all 0.3s ease;
  }

  .tech-btn:hover {
    border-color: var(--tw-colors-neon-green);
    color: var(--tw-colors-neon-green);
  }

  .tech-color {
    width: 50px;
    height: 50px;
    border: none;
    border-radius: 8px;
    background: transparent;
    cursor: pointer;
  }

  .gadget-description {
    line-height: 1.8;
    color: rgba(245, 243, 238, 0.9);
    margin-top: 3rem;
    font-size: 1.1rem;
  }

  .gadget-description p {
    margin-bottom: 1.5rem;
  }

  .gadget-description strong {
    color: var(--tw-colors-fox-red);
  }

  .gadget-description ul {
    list-style: disc;
    margin-left: 2rem;
    margin-bottom: 2rem;
  }

  .gadget-description li {
    margin-bottom: 0.5rem;
  }

  .gadget-description a {
    color: var(--tw-colors-neon-green);
    text-decoration: none;
    border-bottom: 1px dashed var(--tw-colors-neon-green);
  }

  /* PROGRESS BAR STYLING */
  #visor::part(progress-bar) {
    background-color: var(--tw-colors-neon-green);
    height: 4px;
  }
</style>

<article class="gadget-single">

  <a href="javascript:history.back()" class="btn-tech-back">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M19 12H5M12 19l-7-7 7-7" />
    </svg>
    SISTEMA_VOLVER
  </a>

  <h1 class="gadget-title">{{ .Title }}</h1>

  <!-- Crear URLs IPFS -->
  {{ $cid := .Site.Params.glb_cid }}
  {{ $base := .Site.Params.ipfsBase }}

  {{ $glbOriginal := printf "%s%s/%s" $base $cid .Params.glb }}
  {{ $glbClay := "" }}
  {{ if .Params.glbt }}
  {{ $glbClay = printf "%s%s/%s" $base $cid .Params.glbt }}
  {{ end }}

  <div class="visual-container">
    <!-- PREVIEW -->
    <img id="preview" src="{{ .Params.image }}" alt="{{ .Title }}" onclick="mostrarViewer()">

    <!-- VISOR PRINCIPAL -->
    <model-viewer id="visor" src="{{ $glbOriginal }}" camera-controls auto-rotate disable-pan style="display:none;">

      <!-- üß¨ LOADER DAR3D -->
      <div slot="poster" class="dar3d-loader">
        <img src="/svg/dar3d-loader.svg" alt="Cargando DAR3D">
        <span>SINCRONIZANDO INTERFAZ 3D‚Ä¶</span>
        <span>COMPILANDO N√öCLEO...</span>
      </div>

      <a href="https://docs.google.com/forms/d/e/1FAIpQLScBuTaFwUSKo8T5ld5BZ7UCb-1blyQcp504YxjiZy-KIlEI1Q/viewform?entry.1908425380={{ .Params.ZIP }}"
        target="_blank" class="btn-solicitar-fixed"
        onclick="darEvent('click_request_3d', { gadget_name: '{{ .Title }}', location: 'viewer_overlay' })">
        SOLICITAR 3D GRATUITO ‚Üí
      </a>
    </model-viewer>
  </div>

  <!-- PANEL DE CONTROL -->
  <div id="panel" style="display:none;">
    <h3>Configuraci√≥n de Visualizaci√≥n</h3>

    <div class="panel-row">
      <span class="panel-label">Renderizado de Pol√≠gonos</span>
      <button id="btnTexturas" class="tech-btn" onclick="toggleOverride()">
        MODO_S√ìLIDO: DESACTIVADO
      </button>
    </div>

    <div class="panel-row">
      <span class="panel-label">Croma del Modelo</span>
      <input type="color" id="colorPicker" class="tech-color" value="#828282" onchange="cambiarColorOverride()">
    </div>

    <div class="panel-row">
      <span class="panel-label">Entorno de Simulaci√≥n</span>
      <select id="bgSelect" class="tech-select" onchange="cambiarFondo()">
        <option value="transparent">Transparente (Deep Void)</option>
        <option value="white">Laboratorio (Blanco)</option>
        <option value="black">Vac√≠o (Negro)</option>
        <option value="grey">Hangar (Gris)</option>
      </select>
    </div>

    <div class="panel-row">
      <button class="tech-btn" style="border-color: var(--tw-colors-fox-red); color: var(--tw-colors-fox-red);"
        onclick="resetCamara()">REINICIAR_C√ÅMARA</button>
    </div>
  </div>

  <div class="gadget-description">
    {{ .Content }}
  </div>

  <div style="margin-top: 4rem; text-align: center;">
    <button id="btnFooterAction"
      style="display:inline-block; padding:1.2rem 3rem; border-radius:12px; background:var(--tw-colors-fox-red); color:white; text-decoration:none; font-family:var(--tw-font-family-title); border:none; cursor:pointer; letter-spacing:1px; transform: skew(-10deg);"
      onclick="triggerAction()">
      INICIAR PROTOCOLO 3D ‚Üí
    </button>
  </div>

</article>


<script>
  const visor = document.getElementById("visor");

  // GLB v√≠a Hugo -> JS
  const glbOriginal = "{{ $glbOriginal }}";
  const glbClay = "{{ $glbClay }}";

  let overrideActivo = false;
  let currentColor = "#828282";

  /* Mostrar visor */
  function mostrarViewer() {
    document.getElementById("preview").style.display = "none";
    visor.style.display = "block";
    document.getElementById("panel").style.display = "block";

    darEvent('open_3d_viewer', {
      model_type: 'gadget',
      name: '{{ .Title }}'
    });

    // Sincronizar texto del bot√≥n inferior
    const footerBtn = document.getElementById("btnFooterAction");
    if (footerBtn) footerBtn.textContent = "SOLICITAR ACCESO 3D ‚Üí";
  }

  /* Acci√≥n del bot√≥n inferior */
  function triggerAction() {
    if (visor.style.display === "none") {
      mostrarViewer();
      document.querySelector(".visual-container").scrollIntoView({ behavior: 'smooth' });
    } else {
      const zip = '{{ .Params.ZIP }}';
      const url = `https://docs.google.com/forms/d/e/1FAIpQLScBuTaFwUSKo8T5ld5BZ7UCb-1blyQcp504YxjiZy-KIlEI1Q/viewform?entry.1908425380=${zip}`;
      window.open(url, '_blank');
      darEvent('click_request_3d', { gadget_name: '{{ .Title }}', zip: zip });
    }
  }

  // Track interaction
  let hasInteracted = false;
  visor.addEventListener('camera-change', () => {
    if (!hasInteracted) {
      hasInteracted = true;
      darEvent('interact_3d_model', {
        model_type: 'gadget',
        name: '{{ .Title }}',
        source: 'gadget_single'
      });
    }
  });

  /* Aplicar color (Capa de Sombreado S√≥lido) */
  function aplicarColor(colorHex) {
    if (!visor.model || !visor.model.materials) return;

    const r = parseInt(colorHex.substr(1, 2), 16) / 255;
    const g = parseInt(colorHex.substr(3, 2), 16) / 255;
    const b = parseInt(colorHex.substr(5, 2), 16) / 255;

    visor.model.materials.forEach(mat => {
      mat.pbrMetallicRoughness.setBaseColorFactor([r, g, b, 1]);
      mat.pbrMetallicRoughness.metallicFactor = 0;
      mat.pbrMetallicRoughness.roughnessFactor = 1;
    });
  }

  function cambiarColorOverride() {
    currentColor = document.getElementById("colorPicker").value;
    if (overrideActivo) aplicarColor(currentColor);
    darEvent('customize_gadget', { action: 'change_color', color: currentColor, name: '{{ .Title }}' });
  }

  /* Conmutador de Modo S√≥lido */
  function toggleOverride() {
    overrideActivo = !overrideActivo;
    const btn = document.getElementById("btnTexturas");

    if (overrideActivo) {
      // Intentar usar GLB espec√≠fico para clay si existe y es largo (URL v√°lida)
      if (glbClay && glbClay.length > 20) {
        visor.src = glbClay;
        const onLoaded = () => {
          aplicarColor(currentColor);
          visor.removeEventListener('load', onLoaded);
        };
        visor.addEventListener('load', onLoaded);
        btn.textContent = "MODO_S√ìLIDO: ACTIVADO (N√öCLEO_EXTERNO)";
      } else {
        // Si no hay GLB extra o es sospechoso, aplicamos color al original
        aplicarColor(currentColor);
        btn.textContent = "MODO_S√ìLIDO: ACTIVADO";
      }
    } else {
      // Restaurar original simplemente recargando el src
      visor.src = glbOriginal;
      btn.textContent = "MODO_S√ìLIDO: DESACTIVADO";
    }
  }

  /* Entorno */
  function cambiarFondo() {
    visor.style.background = document.getElementById("bgSelect").value;
  }

  /* Reset */
  function resetCamara() {
    visor.resetTurntableRotation();
    visor.cameraOrbit = "0deg 75deg 2.5m";
  }
</script>

{{ end }}