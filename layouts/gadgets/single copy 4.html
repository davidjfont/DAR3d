{{ define "main" }}

<article class="gadget-single" style="max-width:900px;margin:0 auto;padding:2rem;">



  <h1 style="margin-top:3rem;">{{ .Title }}</h1>
  

  <!-- PREVIEW -->
  <img id="preview" src="{{ .Params.image }}" alt="{{ .Title }}"
      style="width:100%;border-radius:12px;margin-bottom:20px;cursor:pointer;"
      onclick="mostrarViewer()">
              <!-- BOTÓN VOLVER -->
  <button onclick="history.back()"
          style="position:relative; left:20px; top:20px;
                 background:none; border:none; font-size:22px;
                 cursor:pointer;">
    ← Volver
  </button>

  <!-- VISOR PRINCIPAL -->
  <model-viewer id="visor"
      src="{{ .Params.glb }}"
      camera-controls
      auto-rotate
      disable-pan
      style="display:none;width:100%;height:500px;border-radius:12px;background:white;">
        <!-- BOTÓN VOLVER -->
  <button onclick="history.back()"
          style="position:absolute; left:20px; top:20px;
                 background:none; border:none; font-size:22px;
                 cursor:pointer;">
    ← Volver
  </button>
  </model-viewer>

  <!-- PANEL -->
  <div id="panel"
      style="display:none; margin-top:20px; padding:15px; border-radius:12px;
              background:#f3f3f3; border:1px solid #ddd; max-width:500px;">

    <h3 style="margin-top:0;">Opciones del visor</h3>

    <!-- TOGGLE GLB -->
    <label><strong>Color sólido:</strong></label><br>
    <button id="btnTexturas"
            style="padding:6px 14px; cursor:pointer;border-radius: 3px;border-width: 1px;background-color: rgb(202, 202, 202);"
            onclick="toggleOverride()">
      Mostrar color sólido
    </button>
    <br><br>

    <!-- PICKER -->
    <label><strong>Color del modelo:</strong></label><br>
    <input type="color" id="colorPicker" value="#828282"
           onchange="cambiarColorOverride()">
    <br><br>

    <!-- FONDO -->
    <label><strong>Fondo:</strong></label><br>
    <select id="bgSelect" onchange="cambiarFondo()">
      <option value="white">Blanco</option>
      <option value="black">Negro</option>
      <option value="grey">Gris</option>
      <option value="transparent">Transparente</option>
    </select>
    <br><br>

    <button onclick="resetCamara()">Reset cámara</button>

  </div>

  <div style="margin-top:20px;">
    {{ .Content }}
  </div>

  
  <a href="https://docs.google.com/forms/d/e/1FAIpQLScBuTaFwUSKo8T5ld5BZ7UCb-1blyQcp504YxjiZy-KIlEI1Q/viewform?entry.1908425380={{ .Params.ZIP }}" target="_blank"
    style="display:inline-block;padding:12px 24px;border-radius:8px;background:black;
            color:white;text-decoration:none;margin-top:20px;">
    Solicitar 3D Gratuito ->
  </a>

</article>

<script type="module"
        src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<script>
const visor = document.getElementById("visor");

// GLB ORIGINAL Y GLB CLAY
const glbOriginal = "{{ .Params.glb }}";
const glbClay     = "{{ .Params.glbt }}";

// Estado
let overrideActivo = false;
let currentColor = "#828282"; // Gris inicial persistente

/* =====================================================
   MOSTRAR VISOR
===================================================== */
function mostrarViewer() {
  document.getElementById("preview").style.display = "none";
  visor.style.display = "block";
  document.getElementById("panel").style.display = "block";
}

/* =====================================================
   APLICAR COLOR AL MODELO
===================================================== */
function aplicarColor(colorHex) {
  if (!visor.model) return;

  const r = parseInt(colorHex.substr(1,2),16) / 255;
  const g = parseInt(colorHex.substr(3,2),16) / 255;
  const b = parseInt(colorHex.substr(5,2),16) / 255;

  for (const mat of visor.model.materials) {
    mat.pbrMetallicRoughness.setBaseColorFactor([r, g, b, 1]);
    mat.pbrMetallicRoughness.metallicFactor = 0;
    mat.pbrMetallicRoughness.roughnessFactor = 1;
  }
}

/* =====================================================
   PICKER DE COLOR
===================================================== */
function cambiarColorOverride() {
  currentColor = document.getElementById("colorPicker").value;

  if (overrideActivo) aplicarColor(currentColor);
}

/* =====================================================
   CAMBIAR ENTRE GLB NORMAL Y "CLAY"
===================================================== */
function toggleOverride() {
  overrideActivo = !overrideActivo;

  if (overrideActivo) {
    visor.src = glbClay;
    visor.addEventListener("load", () => aplicarColor(currentColor), { once:true });
    document.getElementById("btnTexturas").textContent = "Mostrar textura original";
  } else {
    visor.src = glbOriginal;
    document.getElementById("btnTexturas").textContent = "Mostrar color sólido";
  }
}

/* =====================================================
   FONDO
===================================================== */
function cambiarFondo() {
  visor.style.background = document.getElementById("bgSelect").value;
}

/* =====================================================
   RESET CÁMARA
===================================================== */
function resetCamara() {
  visor.resetTurntableRotation();
  visor.cameraOrbit = "0deg 75deg 2.5m";
}
</script>

{{ end }}
