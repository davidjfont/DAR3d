{{ define "main" }}
{{ $slug := .Params.slug }}
{{ $data := site.Data.criaturas }}

{{/* Buscar en TODAS las categor√≠as y subcategor√≠as */}}
{{ $found := dict }}

{{ range $cat, $subs := $data }}
{{ range $sub, $items := $subs }}
{{ range $name, $item := $items }}
{{ if eq (urlize $name) $slug }}
{{ $found = merge $item (dict "nombre" $name "categoria" $cat "subcategoria" $sub) }}
{{ end }}
{{ end }}
{{ end }}
{{ end }}

{{/* BASE IPFS ‚Äì cambia esto si usas otro CID o gateway */}}
{{ $ipfsBase := "https://w3s.link/ipfs/bafybeia72hosqwsvmoj3knqp3ihe5dmuiwbayhyrvalsd3gv4ktmoit7oa/" }}

{{/* Nombre del GLB desde el YAML (glb_name) */}}
{{ $glbName := index $found "glb_name" }}

{{/* Construimos la URL completa al GLB en IPFS */}}
{{ $glbURL := "" }}
{{ if $glbName }}
{{ $glbURL = printf "%s%s" $ipfsBase $glbName }}
{{ end }}

<style>
  .creature-single {
    max-width: 1100px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
    color: var(--color-bone-white);
  }

  .creature-title {
    font-family: var(--font-title);
    font-size: 3.5rem;
    color: var(--color-bone-white);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .creature-category-badge {
    display: inline-block;
    padding: 0.3rem 1rem;
    background: rgba(229, 68, 42, 0.2);
    border: 1px solid rgb(var(--color-fox-red));
    color: rgb(var(--color-fox-red));
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
    text-transform: uppercase;
    margin-bottom: 2rem;
    font-family: monospace;
  }

  .creature-description-header {
    font-size: 1.25rem;
    line-height: 1.6;
    color: var(--color-prose-text);
    margin-bottom: 3rem;
    max-width: 800px;
    border-left: 3px solid rgb(var(--color-neon-green));
    padding-left: 1.5rem;
  }

  /* CARDS */
  .creature-visual-grid {
    display: grid;
    gap: 2.5rem;
  }

  @media (min-width: 768px) {
    .creature-visual-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .visual-card {
    background: color-mix(in srgb, rgb(var(--color-ui-dark-gray)) 40%, transparent);
    border: 1px solid rgba(229, 68, 42, 0.2);
    border-radius: 24px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    display: flex;
    flex-direction: column;
  }

  .visual-card img {
    width: 100%;
    height: auto;
    display: block;
  }

  #visor-criatura {
    width: 100%;
    height: 600px;
    background: transparent;
  }

  /* BUTTONS TECH */
  .btn-solicitar-criatura {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 1.25rem;
    background: rgb(var(--color-fox-red));
    color: white;
    text-decoration: none;
    font-family: var(--font-title);
    font-size: 1.1rem;
    transition: all 0.3s ease;
    border: none;
    width: 100%;
    margin-top: auto;
  }

  .btn-solicitar-criatura:hover {
    filter: brightness(1.1);
    box-shadow: 0 0 20px rgba(229, 68, 42, 0.4);
  }

  .tech-footer-label {
    padding: 1rem;
    background: rgba(0, 0, 0, 1);
    color: rgba(245, 243, 238, 0.4);
    font-size: 0.7rem;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: monospace;
  }

  /* METADATA PANEL */
  .meta-panel {
    margin-top: 4rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
    padding: 2rem;
    background: color-mix(in srgb, rgb(var(--color-ui-dark-gray)) 50%, transparent);
    border: 1px solid rgba(92, 255, 191, 0.1);
    border-radius: 16px;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .meta-label {
    font-size: 0.75rem;
    color: rgb(var(--color-neon-green));
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: monospace;
  }

  .meta-value {
    font-size: 1.1rem;
    color: rgb(var(--color-bone-white));
    font-weight: 500;
  }

  /* SCROLLBAR & PROGRESS */
  #visor-criatura::part(progress-bar) {
    background-color: rgb(var(--color-neon-green));
    height: 4px;
  }
</style>

<div class="creature-single">

  <div class="creature-category-badge">
    {{ T "label_system_id" }} // {{ T (printf "cat_%s" $found.categoria) | default $found.categoria }}
  </div>

  <h1 class="creature-title">{{ T $found.nombre | default $found.nombre }}</h1>

  <div class="creature-description-header">
    {{ if .Params.description }}
    {{ .Params.description }}
    {{ else }}
    {{ T $found.desc | default $found.desc }}
    {{ end }}
  </div>

  <div class="creature-visual-grid">

    <!-- REGISTRO VISUAL (PNG) -->
    <div class="visual-card">
      <img src="{{ $found.img }}" alt="{{ $found.nombre }}">
      <div class="tech-footer-label">{{ T "label_static_capture" }}</div>
    </div>

    <!-- N√öCLEO 3D (GLB) -->
    <div class="visual-card">
      <model-viewer id="visor-criatura" src="{{ $glbURL }}"
        alt="3D Model: {{ T $found.nombre | default $found.nombre }}" camera-controls auto-rotate auto-rotate-delay="0"
        shadow-intensity="1" exposure="1" interaction-prompt="none">

        <!-- üß¨ LOADER DAR3D -->
        <div slot="poster" class="dar3d-loader">
          <img src="/svg/dar3d-loader.svg" alt="DAR3D Loader">
          <span>{{ T "loader_sync_core" }}</span>
          <span>{{ T $found.nombre | default $found.nombre | upper }}</span>
        </div>

      </model-viewer>

      {{ $zip := index $found "zip" | default (index $found "ZIP") }}
      {{ if $zip }}
      {{ $formID := "1FAIpQLScBuTaFwUSKo8T5ld5BZ7UCb-1blyQcp504YxjiZy-KIlEI1Q" }}
      {{ if eq site.Language.Lang "en" }}
      {{ $formID = "1FAIpQLSfY0dRA6ILvP7PaR_eDLGYg3zB3IkQNkciaploVTgqtNtN-lA" }}
      {{ end }}
      <a href="https://docs.google.com/forms/d/e/{{ $formID }}/viewform?entry.1908425380={{ $zip }}" target="_blank"
        class="btn-solicitar-criatura"
        onclick="darEvent('click_request_3d', { model_name: '{{ $found.nombre }}', location: 'single_creature_page', zip: '{{ $zip }}' })">

        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" />
        </svg>

        <span>{{ T "btn_request_3d" }}</span>
      </a>
      <div class="tech-footer-label">{{ T "label_obj_compatible" }}</div>
      {{ else }}
      <div class="tech-footer-label">{{ T "label_holographic_active" }}</div>
      {{ end }}
    </div>

  </div>

  <!-- ESPECIFICACIONES T√âCNICAS -->
  <div class="meta-panel">
    <div class="meta-item">
      <span class="meta-label">{{ T "meta_category" }}</span>
      <span class="meta-value">{{ T (printf "cat_%s" $found.categoria) | default $found.categoria }}</span>
    </div>
    <div class="meta-item">
      <span class="meta-label">{{ T "meta_subcategory" }}</span>
      <span class="meta-value">{{ T (printf "subcat_%s" $found.subcategoria) | default $found.subcategoria }}</span>
    </div>
    <div class="meta-item">
      <span class="meta-label">{{ T "meta_type" }}</span>
      <span class="meta-value">{{ T $found.tipo | default $found.tipo }}</span>
    </div>
    <div class="meta-item">
      <span class="meta-label">{{ T "meta_artifact_id" }}</span>
      <span class="meta-value">{{ $glbName | default "N/A" }}</span>
    </div>
  </div>

  <div class="mt-12 text-prose-text leading-relaxed max-w-4xl">
    {{ .Content }}
  </div>

  {{/* --- NARRATIVE NAVIGATION LOGIC --- */}}
  {{ $flatCreatures := slice }}

  {{/* Get and sort Categories */}}
  {{ $cats := slice }}
  {{ range $k, $v := $data }}
  {{ $cats = $cats | append $k }}
  {{ end }}
  {{ $cats = sort $cats }}

  {{ range $cKey := $cats }}
  {{ $subsMap := index $data $cKey }}

  {{/* Get and sort Subcategories */}}
  {{ $subs := slice }}
  {{ range $k, $v := $subsMap }}
  {{ $subs = $subs | append $k }}
  {{ end }}
  {{ $subs = sort $subs }}

  {{ range $sKey := $subs }}
  {{ $itemsMap := index $subsMap $sKey }}

  {{/* Get and sort Items */}}
  {{ $items := slice }}
  {{ range $k, $v := $itemsMap }}
  {{ $items = $items | append $k }}
  {{ end }}
  {{ $items = sort $items }}

  {{ range $iName := $items }}
  {{ $itemData := index $itemsMap $iName }}
  {{ $itemSlug := urlize $iName }}
  {{ $flatCreatures = $flatCreatures | append (merge $itemData (dict "name" $iName "slug" $itemSlug)) }}
  {{ end }}
  {{ end }}
  {{ end }}

  {{/* Find current index */}}
  {{ $currentIndex := -1 }}
  {{ range $idx, $el := $flatCreatures }}
  {{ if eq $el.slug $slug }}
  {{ $currentIndex = $idx }}
  {{ end }}
  {{ end }}

  {{/* Calc Neighbors */}}
  {{ $prev := dict }}
  {{ $next := dict }}
  {{ $total := len $flatCreatures }}

  {{ if ge $currentIndex 0 }}
  {{ if gt $currentIndex 0 }}
  {{ $prev = index $flatCreatures (sub $currentIndex 1) }}
  {{ end }}
  {{ if lt $currentIndex (sub $total 1) }}
  {{ $next = index $flatCreatures (add $currentIndex 1) }}
  {{ end }}
  {{ end }}

  <!-- NARRATIVE SEO FOOTER -->
  <div class="mt-20 pt-10 border-t border-fox-red/20">

    <!-- NETWORK NAVIGATION -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-6 items-center mb-12">
      <!-- PREV -->
      <div class="text-left">
        {{ if $prev }}
        <a href="{{ relLangURL (printf "/criaturas/%s/" $prev.slug) }}" class="group flex flex-col">
          <span
            class="text-[0.65rem] font-mono text-neon-green uppercase tracking-widest mb-1 group-hover:text-fox-red transition-colors">
            &larr; {{ T "prev_entity" | default "ANTERIOR" }}
          </span>
          <span class="font-title text-sm text-bone-white group-hover:text-white transition-colors">
            {{ $prev.name }}
          </span>
        </a>
        {{ else }}
        <div class="opacity-20 cursor-not-allowed">
          <span class="text-[0.65rem] font-mono uppercase tracking-widest">&larr; END_OF_LOG</span>
        </div>
        {{ end }}
      </div>

      <!-- CENTER HUB -->
      <div class="hidden md:flex flex-col items-center justify-center text-center">
        <a href="{{ relLangURL " /lore/" }}"
          class="w-12 h-12 flex items-center justify-center rounded-full bg-ui-dark-gray border border-fox-red/30 hover:bg-fox-red hover:border-white transition-all duration-300 group shadow-[0_0_20px_rgba(229,68,42,0.2)]">
          <svg class="w-5 h-5 text-fox-red group-hover:text-white transition-colors" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg>
        </a>
        <span class="mt-2 text-[0.6rem] font-mono text-bone-white/40 uppercase tracking-widest">DAR3D_ARCHIVE</span>
      </div>

      <!-- NEXT -->
      <div class="text-right">
        {{ if $next }}
        <a href="{{ relLangURL (printf " /criaturas/%s/" $next.slug) }}" class="group flex flex-col items-end">
          <span
            class="text-[0.65rem] font-mono text-neon-green uppercase tracking-widest mb-1 group-hover:text-fox-red transition-colors">
            {{ T "next_entity" | default "SIGUIENTE" }} &rarr;
          </span>
          <span class="font-title text-sm text-bone-white group-hover:text-white transition-colors">
            {{ $next.name }}
          </span>
        </a>
        {{ else }}
        <div class="opacity-20 cursor-not-allowed flex flex-col items-end">
          <span class="text-[0.65rem] font-mono uppercase tracking-widest">END_OF_LOG &rarr;</span>
        </div>
        {{ end }}
      </div>
    </div>

    <!-- SEO NARRATIVE BLOCK -->
    <div class="bg-deep-black/30 border border-white/5 rounded-xl p-6 backdrop-blur-sm">
      {{ $archiveURL := relLangURL "/#creatures" }}
      {{ $gadgetsURL := relLangURL "/gadgets/" }}
      <p class="text-sm md:text-base text-center leading-relaxed text-bone-white/70 font-light max-w-3xl mx-auto mb-6">
        {{ T "seo_narrative_prefix" | default "Esta criatura pertenece al universo DAR3D." }}
        <a href="{{ $archiveURL }}"
          class="text-neon-green hover:text-fox-red border-b border-neon-green/30 hover:border-fox-red transition-all ml-1">{{
          T "seo_narrative_link_creatures" | default "Descubre m√°s entidades" }}</a>
        {{ T "seo_narrative_connector" | default "y" }}
        <a href="{{ $gadgetsURL }}"
          class="text-neon-green hover:text-fox-red border-b border-neon-green/30 hover:border-fox-red transition-all mx-1">{{
          T "seo_narrative_link_gadgets" | default "tecnolog√≠a emergente" }}</a>.
        {{ T "seo_narrative_suffix" | default `Explora la convergencia entre biolog√≠a sint√©tica y dise√±o 3D en nuestros
        archivos.` }}
      </p>

      <div class="flex justify-center">
        {{ $treeHash := printf "/#tree-%s" $slug | relLangURL }}
        <a href="{{ $treeHash }}"
          class="px-8 py-3 bg-neon-green text-deep-black font-title font-bold rounded-lg hover:bg-fox-red hover:text-white transition-all transform hover:scale-105 shadow-lg uppercase tracking-widest text-sm">
          {{ T "goto_archive" | default "VER EN ARCHIVO" }} ‚Üí
        </a>
      </div>
    </div>

  </div>

</div>
{{ end }}