{{ define "main" }}
{{ $slug := .Params.slug }}
{{ $data := site.Data.criaturas }}

{{/* Buscar en TODAS las categor√≠as y subcategor√≠as */}}
{{ $found := dict }}

{{ range $cat, $subs := $data }}
{{ range $sub, $items := $subs }}
{{ range $name, $item := $items }}
{{ if eq (urlize $name) $slug }}
{{ $found = merge $item (dict "nombre" $name "categoria" $cat "subcategoria" $sub) }}
{{ end }}
{{ end }}
{{ end }}
{{ end }}

{{/* BASE IPFS ‚Äì cambia esto si usas otro CID o gateway */}}
{{ $ipfsBase := "https://w3s.link/ipfs/bafybeia72hosqwsvmoj3knqp3ihe5dmuiwbayhyrvalsd3gv4ktmoit7oa/" }}

{{/* Nombre del GLB desde el YAML (glb_name) */}}
{{ $glbName := index $found "glb_name" }}

{{/* Construimos la URL completa al GLB en IPFS */}}
{{ $glbURL := "" }}
{{ if $glbName }}
{{ $glbURL = printf "%s%s" $ipfsBase $glbName }}
{{ end }}

<style>
  .creature-single {
    max-width: 1100px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
    color: var(--tw-colors-bone-white);
  }

  .creature-title {
    font-family: var(--tw-font-family-title);
    font-size: 3.5rem;
    color: var(--tw-colors-bone-white);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .creature-category-badge {
    display: inline-block;
    padding: 0.3rem 1rem;
    background: rgba(229, 68, 42, 0.2);
    border: 1px solid var(--tw-colors-fox-red);
    color: var(--tw-colors-fox-red);
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
    text-transform: uppercase;
    margin-bottom: 2rem;
    font-family: monospace;
  }

  .creature-description-header {
    font-size: 1.25rem;
    line-height: 1.6;
    color: rgba(245, 243, 238, 0.8);
    margin-bottom: 3rem;
    max-width: 800px;
    border-left: 3px solid var(--tw-colors-neon-green);
    padding-left: 1.5rem;
  }

  /* CARDS */
  .creature-visual-grid {
    display: grid;
    gap: 2.5rem;
  }

  @media (min-width: 768px) {
    .creature-visual-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .visual-card {
    background: rgba(32, 35, 38, 0.4);
    border: 1px solid rgba(229, 68, 42, 0.2);
    border-radius: 24px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    display: flex;
    flex-direction: column;
  }

  .visual-card img {
    width: 100%;
    height: auto;
    display: block;
  }

  #visor-criatura {
    width: 100%;
    height: 600px;
    background: transparent;
  }

  /* BUTTONS TECH */
  .btn-solicitar-criatura {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 1.25rem;
    background: var(--tw-colors-fox-red);
    color: white;
    text-decoration: none;
    font-family: var(--tw-font-family-title);
    font-size: 1.1rem;
    transition: all 0.3s ease;
    border: none;
    width: 100%;
    margin-top: auto;
  }

  .btn-solicitar-criatura:hover {
    filter: brightness(1.1);
    box-shadow: 0 0 20px rgba(229, 68, 42, 0.4);
  }

  .tech-footer-label {
    padding: 1rem;
    background: rgba(0, 0, 0, 0.3);
    color: rgba(245, 243, 238, 0.4);
    font-size: 0.7rem;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: monospace;
  }

  /* METADATA PANEL */
  .meta-panel {
    margin-top: 4rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
    padding: 2rem;
    background: rgba(10, 10, 10, 0.5);
    border: 1px solid rgba(92, 255, 191, 0.1);
    border-radius: 16px;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .meta-label {
    font-size: 0.75rem;
    color: var(--tw-colors-neon-green);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: monospace;
  }

  .meta-value {
    font-size: 1.1rem;
    color: var(--tw-colors-bone-white);
    font-weight: 500;
  }

  /* SCROLLBAR & PROGRESS */
  #visor-criatura::part(progress-bar) {
    background-color: var(--tw-colors-neon-green);
    height: 4px;
  }
</style>

<div class="creature-single">

  <div class="creature-category-badge">
    {{ T "label_system_id" }} // {{ T (printf "cat_%s" $found.categoria) | default $found.categoria }}
  </div>

  <h1 class="creature-title">{{ T $found.nombre | default $found.nombre }}</h1>

  <div class="creature-description-header">
    {{ if .Params.description }}
    {{ .Params.description }}
    {{ else }}
    {{ T $found.desc | default $found.desc }}
    {{ end }}
  </div>

  <div class="creature-visual-grid">

    <!-- REGISTRO VISUAL (PNG) -->
    <div class="visual-card">
      <img src="{{ $found.img }}" alt="{{ $found.nombre }}">
      <div class="tech-footer-label">{{ T "label_static_capture" }}</div>
    </div>

    <!-- N√öCLEO 3D (GLB) -->
    <div class="visual-card">
      <model-viewer id="visor-criatura" src="{{ $glbURL }}"
        alt="3D Model: {{ T $found.nombre | default $found.nombre }}" camera-controls auto-rotate auto-rotate-delay="0"
        shadow-intensity="1" exposure="1" interaction-prompt="none">

        <!-- üß¨ LOADER DAR3D -->
        <div slot="poster" class="dar3d-loader">
          <img src="/svg/dar3d-loader.svg" alt="DAR3D Loader">
          <span>{{ T "loader_sync_core" }}</span>
          <span>{{ T $found.nombre | default $found.nombre | upper }}</span>
        </div>

      </model-viewer>

      {{ $zip := index $found "zip" | default (index $found "ZIP") }}
      {{ if $zip }}
      <a href="https://docs.google.com/forms/d/e/1FAIpQLScBuTaFwUSKo8T5ld5BZ7UCb-1blyQcp504YxjiZy-KIlEI1Q/viewform?entry.1908425380={{ $zip }}"
        target="_blank" class="btn-solicitar-criatura"
        onclick="darEvent('click_request_3d', { model_name: '{{ $found.nombre }}', location: 'single_creature_page', zip: '{{ $zip }}' })">

        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" />
        </svg>

        <span>{{ T "btn_request_3d" }}</span>
      </a>
      <div class="tech-footer-label">{{ T "label_obj_compatible" }}</div>
      {{ else }}
      <div class="tech-footer-label">{{ T "label_holographic_active" }}</div>
      {{ end }}
    </div>

  </div>

  <!-- ESPECIFICACIONES T√âCNICAS -->
  <div class="meta-panel">
    <div class="meta-item">
      <span class="meta-label">{{ T "meta_category" }}</span>
      <span class="meta-value">{{ T (printf "cat_%s" $found.categoria) | default $found.categoria }}</span>
    </div>
    <div class="meta-item">
      <span class="meta-label">{{ T "meta_subcategory" }}</span>
      <span class="meta-value">{{ T (printf "subcat_%s" $found.subcategoria) | default $found.subcategoria }}</span>
    </div>
    <div class="meta-item">
      <span class="meta-label">{{ T "meta_type" }}</span>
      <span class="meta-value">{{ T $found.tipo | default $found.tipo }}</span>
    </div>
    <div class="meta-item">
      <span class="meta-label">{{ T "meta_artifact_id" }}</span>
      <span class="meta-value">{{ $glbName | default "N/A" }}</span>
    </div>
  </div>

  <div class="mt-12 opacity-80 leading-relaxed max-w-4xl">
    {{ .Content }}
  </div>

</div>
{{ end }}