{{/* layouts/partials/glb_viewer.html */}}

{{- $id := .id | default "glb-viewer-hero" -}}
{{- $alt := .alt | default "3D Model" -}}
{{- $height := .height | default "100%" -}}
{{- $src := .src -}}

<!-- Carga de model-viewer (solo hace efecto la primera vez que se incluye) -->
<script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer@3.3.0/dist/model-viewer.min.js">
</script>

<model-viewer id="{{ $id }}" src="{{ $src }}" alt="{{ $alt }}" camera-controls auto-rotate auto-rotate-delay="0"
    shadow-intensity="1" exposure="1" interaction-prompt="none" interaction-prompt-style="none" disable-zoom
    touch-action="none" style="width:100%; height:{{ $height }}; z-index:1000;">

    <!-- ðŸ§¬ LOADER DAR3D -->
    <div slot="poster" class="dar3d-loader">
        <img src="/svg/dar3d-loader.svg" alt="Cargando DAR3D">
        <span>Inicializando artefacto 3Dâ€¦</span>
        <span>Cargando...</span>
    </div>
</model-viewer>

<script>
    (function () {
        const mv = document.getElementById('{{ $id }}');
        let interacted = false; // Local state per instantiation

        if (mv) {
            mv.addEventListener('load', () => {
                // Read current src from element in case it was set dynamically (random mode)
                // mv.src returns full URL, so it might differ slightly from {{ $src }} but is accurate for tracking
                const currentSrc = mv.src || '{{ $src }}';

                darEvent('open_3d_viewer', {
                    model_src: currentSrc,
                    model_id: '{{ $id }}',
                    viewer_type: 'generic_partial'
                });
            });

            mv.addEventListener('camera-change', () => {
                if (!interacted) {
                    interacted = true;
                    // Read current src
                    const currentSrc = mv.src || '{{ $src }}';
                    darEvent('interact_3d_model', {
                        model_src: currentSrc,
                        model_id: '{{ $id }}'
                    });
                }
            });
        }
    })();
</script>