{{/* layouts/partials/glb_viewer.html */}}

{{- $id := .id | default "glb-viewer-hero" -}}
{{- $alt := .alt | default "3D Model" -}}
{{- $height := .height | default "100%" -}}
{{- $src := .src -}}


<model-viewer id="{{ $id }}" src="{{ $src }}" alt="{{ $alt }}" camera-controls auto-rotate auto-rotate-delay="0"
    shadow-intensity="1" exposure="1" interaction-prompt="none" interaction-prompt-style="none" touch-action="pan-y"
    style="width:100%; height:{{ $height }}; z-index:1000;">

    <!-- ðŸ§¬ LOADER DAR3D -->
    <div slot="poster" class="dar3d-loader">
        <img src="/svg/dar3d-loader.svg" alt="Cargando DAR3D">
        <span>Inicializando artefacto 3Dâ€¦</span>
        <span>Cargando...</span>
    </div>

    {{ if .request_zip }}
    {{ $formID := "1FAIpQLScBuTaFwUSKo8T5ld5BZ7UCb-1blyQcp504YxjiZy-KIlEI1Q" }}
    {{ if eq site.Language.Lang "en" }}
    {{ $formID = "1FAIpQLSfY0dRA6ILvP7PaR_eDLGYg3zB3IkQNkciaploVTgqtNtN-lA" }}
    {{ end }}
    <a href="https://docs.google.com/forms/d/e/{{ $formID }}/viewform?entry.1908425380={{ .request_zip }}"
        target="_blank"
        style="position:absolute; bottom:12px; left:12px; background:rgba(0,0,0,0.7); color:white; padding:8px 12px; border-radius:4px; text-decoration:none; font-size:14px; z-index:1000;"
        onclick="darEvent('click_request_3d', { model_name: '{{ .request_name | default " Unknown" }}',
        location: 'generic_viewer' })">
        {{ T "btn_request_3d" | default "Solicitar 3D Gratuito ->" }}
    </a>
    {{ end }}
</model-viewer>

<script>
    (function () {
        const mv = document.getElementById('{{ $id }}');
        let interacted = false; // Local state per instantiation

        if (mv) {
            // OptimizaciÃ³n MÃ³vil: InteracciÃ³n con dos dedos
            // Con un dedo permitimos scroll nativo (pan-y), con dos permitimos rotar/zoom
            const handleTouch = (e) => {
                if (e.touches.length > 1) {
                    mv.setAttribute('camera-controls', '');
                } else {
                    mv.removeAttribute('camera-controls');
                }
            };

            mv.addEventListener('touchstart', handleTouch, { passive: true });
            mv.addEventListener('touchend', handleTouch, { passive: true });

            mv.addEventListener('load', () => {
                // Read current src from element in case it was set dynamically (random mode)
                // mv.src returns full URL, so it might differ slightly from {{ $src }} but is accurate for tracking
                const currentSrc = mv.src || '{{ $src }}';

                darEvent('open_3d_viewer', {
                    model_src: currentSrc,
                    model_id: '{{ $id }}',
                    viewer_type: 'generic_partial'
                });
            });

            mv.addEventListener('camera-change', () => {
                if (!interacted) {
                    interacted = true;
                    // Read current src
                    const currentSrc = mv.src || '{{ $src }}';
                    darEvent('interact_3d_model', {
                        model_src: currentSrc,
                        model_id: '{{ $id }}',
                        source: 'generic_partial'
                    });
                }
            });
        }
    })();
</script>