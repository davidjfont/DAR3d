{{/* layouts/partials/glb_viewer.html */}}

{{- $id := .id | default "glb-viewer-hero" -}}
{{- $alt := .alt | default "3D Model" -}}
{{- $height := .height | default "100%" -}}
{{- $src := .src -}}

<!-- Carga de model-viewer (solo hace efecto la primera vez que se incluye) -->
<script type="module"
        src="https://cdn.jsdelivr.net/npm/@google/model-viewer@3.3.0/dist/model-viewer.min.js">
</script>

<model-viewer
    id="{{ $id }}"
    src="{{ $src }}"
    alt="{{ $alt }}"
    camera-controls
    auto-rotate
    auto-rotate-delay="0"
    shadow-intensity="1"
    exposure="1"
    interaction-prompt="none"
    interaction-prompt-style="none"
    disable-zoom
    touch-action="none"
    style="width:100%; height:{{ $height }}; z-index:1000;">

    <!-- üß¨ LOADER DAR3D -->
    <div slot="poster" class="dar3d-loader">
      <img src="/svg/dar3d-loader.svg" alt="Cargando DAR3D">
      <span>Inicializando artefacto 3D‚Ä¶</span>
      <span>Cargando ${name}‚Ä¶</span>
    </div>
</model-viewer>

{{/* Si NO se ha pasado .src, hacemos que sea aleatorio con JS */}}
{{- if not $src }}
<script>
document.addEventListener("DOMContentLoaded", function () {

    // Si a√∫n no hemos creado la lista global de modelos, la creamos ahora
    if (!window.GLBS || !window.GLBS.length) {
        window.GLBS = [
            {{- range readDir "static/models" -}}
                {{- if eq (lower (path.Ext .Name)) ".glb" -}}
                    "https://w3s.link/ipfs/bafybeia72hosqwsvmoj3knqp3ihe5dmuiwbayhyrvalsd3gv4ktmoit7oa/{{ .Name }}",
                {{- end -}}
            {{- end -}}
        ];
    }

    const modelos = window.GLBS || [];
    if (!modelos.length) {
        console.error("No se encontraron modelos .glb en static/models");
        return;
    }

    const randomModel = modelos[Math.floor(Math.random() * modelos.length)];
    console.log("Model-viewer aleatorio:", randomModel);

    const el = document.getElementById("{{ $id }}");
    if (el) {
        el.src = randomModel;
    }
});
</script>
{{- end }}
