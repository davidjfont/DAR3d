{{/* layouts/partials/glb_viewer.html */}}

{{- $id := .id | default "glb-viewer-hero" -}}
{{- $alt := .alt | default "3D Model" -}}
{{- $height := .height | default "100%" -}}
{{- $src := .src -}}

<!-- Carga de model-viewer (solo hace efecto la primera vez que se incluye) -->
<script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer@3.3.0/dist/model-viewer.min.js">
</script>

<model-viewer id="{{ $id }}" src="{{ $src }}" alt="{{ $alt }}" camera-controls auto-rotate auto-rotate-delay="0"
    shadow-intensity="1" exposure="1" interaction-prompt="none" interaction-prompt-style="none" disable-zoom
    touch-action="none" style="width:100%; height:{{ $height }}; z-index:1000;">

    <!-- ðŸ§¬ LOADER DAR3D -->
    <div slot="poster" class="dar3d-loader">
        <img src="/svg/dar3d-loader.svg" alt="Cargando DAR3D">
        <span>Inicializando artefacto 3Dâ€¦</span>
        <span>Cargando...</span>
    </div>

    {{ if .request_zip }}
    <a href="https://docs.google.com/forms/d/e/1FAIpQLScBuTaFwUSKo8T5ld5BZ7UCb-1blyQcp504YxjiZy-KIlEI1Q/viewform?entry.1908425380={{ .request_zip }}"
        target="_blank"
        style="position:absolute; bottom:12px; left:12px; background:rgba(0,0,0,0.7); color:white; padding:8px 12px; border-radius:4px; text-decoration:none; font-size:14px; z-index:1000;"
        onclick="darEvent('click_request_3d', { model_name: '{{ .request_name | default " Unknown" }}',
        location: 'generic_viewer' })">
        Solicitar 3D Gratuito ->
    </a>
    {{ end }}
</model-viewer>

<script>
    (function () {
        const mv = document.getElementById('{{ $id }}');
        let interacted = false; // Local state per instantiation

        if (mv) {
            mv.addEventListener('load', () => {
                // Read current src from element in case it was set dynamically (random mode)
                // mv.src returns full URL, so it might differ slightly from {{ $src }} but is accurate for tracking
                const currentSrc = mv.src || '{{ $src }}';

                darEvent('open_3d_viewer', {
                    model_src: currentSrc,
                    model_id: '{{ $id }}',
                    viewer_type: 'generic_partial'
                });
            });

            mv.addEventListener('camera-change', () => {
                if (!interacted) {
                    interacted = true;
                    // Read current src
                    const currentSrc = mv.src || '{{ $src }}';
                    darEvent('interact_3d_model', {
                        model_src: currentSrc,
                        model_id: '{{ $id }}',
                        source: 'generic_partial'
                    });
                }
            });
        }
    })();
</script>