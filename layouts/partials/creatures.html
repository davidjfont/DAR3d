<section id="creatures" class="pt-16 md:pt-24 max-w-7xl mx-auto px-4 scroll-mt-32">

  <!-- CABECERA -->
  <div class="grid md:grid-cols-3 gap-8 mb-12">

    <h2 class="text-5xl font-title font-bold text-bone-white">
      {{ T "criaturas_title" }}
    </h2>

    <div class="md:col-span-2 text-center md:text-right mt-8 md:mt-0">
      <a href="#criaturaTree" class="inline-block px-6 py-3 text-lg font-semibold rounded-lg
                bg-fox-red text-bone-white
                hover:bg-neon-green hover:text-deep-black
                transition-colors duration-300 shadow-lg"
        onclick="darEvent('go_to_creature_tree', { source: 'home_creatures_section' })">
        {{ T "creatures_button_tree" }}
      </a>
    </div>

  </div>

  <!-- GRID CRIATURAS -->
  <div class="grid md:grid-cols-3 gap-8">

    {{/* Lista de criaturas originales */}}
    {{ $criaturas := slice
    (dict "nombre" "DE DA" "tipo" (T "tipo_organico") "descripcion" (T "david_desc_short") "img" "/images/de-da.png"
    "glb"
    "david%20mutante.glb" "color" "text-fox-red")
    (dict "nombre" "MR-3042" "tipo" (T "tipo_inorganico") "descripcion" (T "mr3042_desc_short") "img"
    "/images/mr-3042-v3.png" "glb" "mr-3042_v3.glb" "color" "text-fox-red")
    (dict "nombre" "ALEFAR" "tipo" (T "tipo_sintetico") "descripcion" (T "alefar_desc_short") "img"
    "/images/sintetica.jpg"
    "glb"
    "sintetica-pistola2.glb" "color" "text-fox-red")
    }}

    {{ range $index, $c := $criaturas }}
    {{ $cSlug := urlize $c.nombre }}
    <div id="creature-{{ $cSlug }}"
      class="bg-deep-black rounded-xl p-6 shadow-xl border border-fox-red/20 criatura-container"
      data-src="https://w3s.link/ipfs/bafybeia72hosqwsvmoj3knqp3ihe5dmuiwbayhyrvalsd3gv4ktmoit7oa/{{ $c.glb }}"
      data-name="{{ $c.nombre }}" data-type="{{ $c.tipo }}" data-t-volver="{{ T " shadow_back" }}"
      data-t-loading="{{ T " shadow_loading_artifact" }}">

      <div class="relative w-full h-[480px] md:h-[700px]
                  rounded-xl overflow-hidden shadow-xl">

        <!-- IMAGEN PREVIA -->
        <img src="{{ $c.img | relURL }}" alt="{{ $c.nombre }}" class="criatura-ficha w-full h-full object-cover
                    rounded-lg border border-fox-red/50
                    shadow-xl cursor-pointer">

        <!-- VISOR 3D -->
        <div class="criatura-3d hidden w-full h-full"></div>

        <!-- BOTÃ“N VOLVER -->
        <button class="volver-btn hidden absolute top-3 right-3
                       bg-black/60 text-white text-sm
                       px-2 py-1 rounded z-20">
          {{ T "shadow_back" }}
        </button>

        {{/* BOTÃ“N WIKI - COMENTADO
        <a href="#" target="_blank" class="wiki-btn hidden absolute bottom-3 right-3
                       bg-black/60 text-white text-sm
                       px-2 py-1 rounded z-[1000] hover:bg-fox-red transition"
          onclick="darEvent('click_wiki_from_viewer', { source: 'home_grid' })">
          â˜… WIKI
        </a>
        */}}

      </div>

      <h3 class="text-2xl font-title cursor-pointer {{ $c.color }}">
        {{ $c.nombre }}
      </h3>
      <p class="text-xs text-neon-green mb-3">
        {{ T "creature_type_label" }}: {{ $c.tipo }}
      </p>
      <p class="opacity-80">
        {{ $c.descripcion }}
      </p>

    </div>
    {{ end }}

  </div>

  <!-- SCRIPT -->
  <script type="module">

    document.addEventListener("DOMContentLoaded", () => {

      document.querySelectorAll('.criatura-container').forEach(container => {

        const img = container.querySelector('.criatura-ficha');
        const viewerWrapper = container.querySelector('.criatura-3d');
        const volverBtn = container.querySelector('.volver-btn');
        const wikiBtn = container.querySelector('.wiki-btn'); // Nueva selecciÃ³n
        const h3 = container.querySelector('h3');

        const glbSrc = container.dataset.src;
        const name = container.dataset.name;

        // Actualizar Link Wiki
        if (wikiBtn) {
          wikiBtn.href = `/criaturas/${slugify(name)}/`;
          // Actualizar evento GA con nombre real (opcional, o dejar el genÃ©rico del HTML)
          wikiBtn.onclick = () => darEvent('click_wiki_from_viewer', { creature_name: name, source: 'home_grid' });
        }

        const type = container.dataset.type;
        const tLoading = container.dataset.tLoading || "Loading...";

        let interacted = false;

        function openViewer() {

          darEvent('view_creature_card', {
            creature_name: name,
            creature_type: type,
            source: 'home'
          });

          img.classList.add('hidden');
          viewerWrapper.classList.remove('hidden');
          volverBtn.classList.remove('hidden');
          if (wikiBtn) wikiBtn.classList.remove('hidden'); // Mostrar wiki

          if (!viewerWrapper.querySelector('model-viewer')) {

            const modelViewer = document.createElement('model-viewer');
            modelViewer.setAttribute('src', glbSrc);
            modelViewer.style.width = '100%';
            modelViewer.style.height = '100%';
            modelViewer.setAttribute('auto-rotate', '');
            modelViewer.setAttribute('camera-controls', '');
            modelViewer.setAttribute('shadow-intensity', '1');
            modelViewer.setAttribute('interaction-prompt', 'none');

            if (window.innerWidth <= 768) {
              modelViewer.setAttribute('disable-zoom', '');
            }

            /* ðŸ§¬ LOADER DAR3D OFICIAL */
            const loader = document.createElement('div');
            loader.setAttribute('slot', 'poster');
            loader.className = 'dar3d-loader';
            loader.innerHTML = `
              <img src="/svg/dar3d-loader.svg" alt="DAR3D Loading">
              <span>${tLoading}</span>
              <span>${name}</span>
            `;

            modelViewer.appendChild(loader);
            viewerWrapper.appendChild(modelViewer);

            darEvent('open_3d_viewer', {
              model: glbSrc,
              creature_name: name
            });

            modelViewer.addEventListener('camera-change', () => {
              if (!interacted) {
                interacted = true;
                darEvent('interact_3d_model', {
                  model: glbSrc,
                  creature_name: name,
                  source: 'home_creatures'
                });
              }
            });
          }
        }

        function closeViewer() {

          darEvent('close_3d_viewer', {
            model: glbSrc,
            creature_name: name
          });

          viewerWrapper.innerHTML = '';
          viewerWrapper.classList.add('hidden');
          volverBtn.classList.add('hidden');
          if (wikiBtn) wikiBtn.classList.add('hidden');
          img.classList.remove('hidden');
          interacted = false;
        }

        img.addEventListener('click', openViewer);
        h3.addEventListener('click', closeViewer);
        volverBtn.addEventListener('click', closeViewer);

      });

      // Helper slugify para generar enlaces wiki
      function slugify(text) {
        return text.toString().toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/\s+/g, '-')
          .replace(/[^\w\-]+/g, '')
          .replace(/\-\-+/g, '-')
          .replace(/^-+/, '')
          .replace(/-+$/, '');
      }

      // --- AUTO-OPEN BY HASH ---
      const hash = window.location.hash;
      if (hash && hash.startsWith('#creature-')) {
        const targetId = hash.substring(1);
        const container = document.getElementById(targetId);
        if (container) {
          const img = container.querySelector('.criatura-ficha');
          if (img) {
            setTimeout(() => {
              img.click();
              container.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
          }
        }
      }

    });
  </script>


</section>